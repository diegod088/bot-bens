{% extends "base.html" %}

{% block title %}Analytics - Admin Console{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Analytics & Monetización</h1>
        <div>
            <button class="btn btn-outline-primary" onclick="refreshData()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                </svg>
                Actualizar
            </button>
        </div>
    </div>

    <!-- Cards de métricas principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-muted mb-1">Usuarios Totales</h6>
                            <h3 class="mb-0" id="total-users">-</h3>
                        </div>
                        <div class="text-primary">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M22 5.5 16.5 11l-1-1L22 3.5 22 5.5z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-muted mb-1">Usuarios Premium</h6>
                            <h3 class="mb-0 text-success" id="premium-users">-</h3>
                            <small class="text-muted" id="premium-percentage">-</small>
                        </div>
                        <div class="text-success">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-muted mb-1">Ingresos Estimados</h6>
                            <h3 class="mb-0 text-warning" id="estimated-revenue">$-</h3>
                            <small class="text-muted">Basado en premium</small>
                        </div>
                        <div class="text-warning">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-muted mb-1">Conversión</h6>
                            <h3 class="mb-0 text-info" id="conversion-rate">-</h3>
                            <small class="text-muted">Free → Premium</small>
                        </div>
                        <div class="text-info">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos y análisis -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Distribución de Usuarios</h5>
                </div>
                <div class="card-body">
                    <canvas id="user-distribution-chart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Descargas por Tipo</h5>
                </div>
                <div class="card-body">
                    <canvas id="downloads-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de usuarios premium recientes -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Usuarios Premium Recientes</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Fecha Premium</th>
                            <th>Expira</th>
                            <th>Descargas</th>
                        </tr>
                    </thead>
                    <tbody id="premium-users-table">
                        <tr>
                            <td colspan="4" class="text-center">Cargando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let userChart, downloadsChart;

document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
});

function refreshData() {
    loadAnalytics();
}

function loadAnalytics() {
    fetch('/api/analytics')
        .then(res => res.json())
        .then(data => {
            updateMetrics(data);
            updateCharts(data);
            updatePremiumTable(data.recent_premium);
        })
        .catch(err => {
            console.error('Error loading analytics:', err);
            Utils.showToast('Error al cargar analytics', 'error');
        });
}

function updateMetrics(data) {
    document.getElementById('total-users').textContent = data.total_users;
    document.getElementById('premium-users').textContent = data.premium_users;
    document.getElementById('premium-percentage').textContent = `${data.premium_percentage}%`;
    document.getElementById('estimated-revenue').textContent = `$${data.estimated_revenue}`;
    document.getElementById('conversion-rate').textContent = `${data.conversion_rate}%`;
}

function updateCharts(data) {
    // Destruir gráficos anteriores si existen
    if (userChart) userChart.destroy();
    if (downloadsChart) downloadsChart.destroy();

    // Gráfico de distribución de usuarios
    const userCtx = document.getElementById('user-distribution-chart').getContext('2d');
    userChart = new Chart(userCtx, {
        type: 'doughnut',
        data: {
            labels: ['Free', 'Premium'],
            datasets: [{
                data: [data.free_users, data.premium_users],
                backgroundColor: ['#6c757d', '#28a745'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Gráfico de descargas por tipo
    const downloadsCtx = document.getElementById('downloads-chart').getContext('2d');
    downloadsChart = new Chart(downloadsCtx, {
        type: 'bar',
        data: {
            labels: ['Videos', 'Fotos', 'Música', 'APKs'],
            datasets: [{
                label: 'Descargas Totales',
                data: [data.total_videos, data.total_photos, data.total_music, data.total_apks],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updatePremiumTable(users) {
    const tbody = document.getElementById('premium-users-table');
    if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">No hay usuarios premium recientes</td></tr>';
        return;
    }

    tbody.innerHTML = users.map(user => `
        <tr>
            <td>
                <strong>${user.first_name || 'N/A'}</strong><br>
                <small class="text-muted">@${user.username || 'N/A'}</small>
            </td>
            <td>${new Date(user.created_at).toLocaleDateString()}</td>
            <td>${user.premium_until ? new Date(user.premium_until).toLocaleDateString() : 'N/A'}</td>
            <td>${user.downloads}</td>
        </tr>
    `).join('');
}
</script>
{% endblock %}